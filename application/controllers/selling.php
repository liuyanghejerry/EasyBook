<?phpclass Selling extends CI_Controller{    	// var $boxart;		function __construct()    {		parent :: __construct();		$this -> load -> helper('html');		$this->load->helper('url');		$this->load->database();		$this->load->library('pagination');		$this->load->model('collageModel');		$this->load->model('sellingModel');		$this->load->library('form_validation');		$this->load->helper('date');				$config['upload_path'] = './resource/uploads/';		$config['allowed_types'] = 'gif|jpg|png';		$config['max_size'] = '1024';		$config['max_width']  = '1024';		$config['max_height']  = '768';		$this->load->library('upload', $config);				$this->lang->load('upload', 'chinese');		$this->lang->load('form_validation', 'chinese');    }    	function _makeHeader(&$data)    {		echo doctype('html5');        $data['keywords'] = 'This, is, keywords';        $data['description'] = 'This is description';        $data['robots'] = 'This is robots part';		$data['javascript'] = array(base_url().'resource/selling/jquery.easing.1.3.js',									base_url().'resource/selling/jquery.accordion.js',									base_url().'resource/selling/validation.js',									// base_url().'resource/selling/jquery.autocomplete.min.js',									base_url().'resource/jquery-ui-1.9.1.custom.min.js',									base_url().'resource/datepicker/js/datepicker.js');		$data['css'] = array(base_url().'resource/common.css',							base_url().'resource/footer/footer.css',							base_url().'resource/datepicker/css/datepicker.css',							base_url().'resource/jquery-ui-1.9.1.custom.min.css',							base_url().'resource/selling/selling.css');		$data['username'] = $this->session->userdata('username');		$data['login'] = $this->session->userdata('login');    }    	function index()    {		$this->page(0,0,0);    }		function category()	{		$k = $this->collageModel->subject();		$p = array();		for($i=0;$i<count($k);$i++){			$p[$i] = $k[$i]['subject_name'];		}		$this->output			->set_content_type('application/json')			->set_output(json_encode($p));	}		function page($collageNum=0, $subjectNum=0, $pageNum = 0)	{		$data = array();		$this -> _makeHeader($data);		$this ->sellingModel-> queryData($data,$collageNum,$subjectNum,$pageNum);		$config['base_url'] = site_url().'/selling/page';		$config['total_rows'] = $data['pages'];		$config['per_page'] = '10'; 		$this->pagination->initialize($config);		$data['pages'] = $this->pagination->create_links();		$data['subjects'] = $this ->sellingModel-> otherSubject($subjectNum, $collageNum);		$data['collages'] = $this ->sellingModel-> otherCollage($collageNum);		$this -> load -> view('header', $data);		$this -> load -> view('selling');		$this -> load -> view('footer');	} 		function single($id=1,$action='show')	{		$data = array();		$this -> _makeHeader($data);		 		$hasData = $this ->sellingModel-> querySelling($data, $id);		if(!$hasData){			redirect('missing');  			return;		}		if($action=='close'){			$book_owner = $this ->sellingModel->whosBook($id);			if($book_owner == $this->session->userdata('userid')){				$this ->sellingModel->closeBook($id);				$data['msgtitle'] = '图书已成功关闭';				$data['msgcontent'] = '图书已成功关闭，将不会再出现在最新售出栏目当中。';				$this -> load -> view('header', $data);				$this -> load -> view('message-template');				$this -> load -> view('footer');				return;			}				}else{			$data['subjects'] = $this ->sellingModel-> sameSubjectBook($id);			$data['collages'] = $this ->sellingModel-> sameCollageBook($id);			$this -> load -> view('header', $data);			$this -> load -> view('selling_single');			$this -> load -> view('footer');			return;		}	} 		function create()	{		$this->form_validation->set_error_delimiters('<div class="warning"><p>', '</p></div>');		// $this->upload->display_errors('<div class="warning"><p>', '</p></div>');		$data=array();		$this -> _makeHeader($data);		$this -> load -> view('header', $data);		$this -> load -> view('selling_create');		$this -> load -> view('footer');	}		function validate()	{		$rules = array(		   array(				 'field'   => 'name', 				 'label'   => '书名', 				 'rules'   => 'trim|required|max_length[20]|xss_clean'			  ),		   array(				 'field'   => 'boxart', 				 'label'   => '封面', 				 'rules'   => 'callback_upload_check'			  ),		   array(				 'field'   => 'author', 				 'label'   => '作者', 				 'rules'   => 'required|trim|xss_clean'			  ),   		   array(				 'field'   => 'isbn', 				 'label'   => 'ISBN', 				 'rules'   => 'trim|required|xss_clean'			  ),		   array(				 'field'   => 'publisher', 				 'label'   => '出版社', 				 'rules'   => 'trim|required|xss_clean'			  ),		   array(				 'field'   => 'oprice', 				 'label'   => '原价', 				 'rules'   => 'required|trim|numeric|xss_clean'			  ),		   array(				 'field'   => 'nprice', 				 'label'   => '现价', 				 'rules'   => 'required|trim|numeric|xss_clean'			  ),		   array(				 'field'   => 'contact', 				 'label'   => '联系电话', 				 'rules'   => 'required|trim|numeric|xss_clean'			  ),		   array(				 'field'   => 'endtime', 				 'label'   => '截止时间', 				 'rules'   => 'trim|required|xss_clean'			  ),		   array(				 'field'   => 'notes', 				 'label'   => '备注', 				 'rules'   => 'trim|xss_clean'			  )		);		$this->form_validation->set_rules($rules);				if( !$this->form_validation->run() ){			$this->create();		}else{			$data = array();			$data['msgtitle'] = '发布成功';			$data['msgcontent'] = '恭喜您，您的售书信息已经完成，请点击<a href="'.base_url().'">返回首页</a>。';			$data['uploadinfo'] = array('upload_data' => $this->upload->data());			$this ->_makeHeader($data);			$this ->load ->view('header', $data);			$this->load->view('message-template');			$this ->load ->view('footer');		}    } 		function upload_check($str)	{		$is_ok = $this->upload->do_upload('boxart');		$this->form_validation->set_message('upload_check', '您的<b>%s</b>上传有误，'.$this->upload->display_errors('', ''));		if($is_ok){			$data = $this->upload->data();			if( !$data['is_image'] ) $is_ok = FALSE;		}		return $is_ok;	}		function _publish()	{			$img_path = $this->upload->data();		$img_path = $img_path['full_path'];		// TODO: insert into db		$data = array(					'book_name' => $this->input->post('name', TRUE),					'book_publisher' => $this->input->post('publisher', TRUE),					'book_author' => $this->input->post('author', TRUE),					'book_isbn' => $this->input->post('isbn', TRUE),					'book_contact' => $this->input->post('contact', TRUE),					'book_oprice' => $this->input->post('oprice', TRUE),					'book_nprice' => $this->input->post('nprice', TRUE),					'selling_end' => $this->input->post('endtime', TRUE),					'book_note' => $this->input->post('notes', TRUE),					'book_boxart' => $img_path		);	}}?>